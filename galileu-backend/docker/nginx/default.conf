# docker/nginx/default.conf

upstream django {
    server web:8000;
}

# Mantém o proto certo (quando vier do cloudflared/CF como https)
map $http_x_forwarded_proto $proxy_proto {
    default $http_x_forwarded_proto;
    ""      $scheme;
}

# Permite CORS apenas para origens que você vai usar
map $http_origin $cors_origin {
    default "";

    # Cloudflare Pages (qualquer subdomínio .pages.dev)
    "~^https://.*\.pages\.dev$"           $http_origin;

    # (Opcional) Se um dia você usar domínio próprio do site
    # "https://galileu.com.br"            $http_origin;

    # Local dev
    "~^http://localhost(:\d+)?$"          $http_origin;
    "~^http://127\.0\.0\.1(:\d+)?$"       $http_origin;
}

server {
    listen 80;
    server_name _;

    # healthcheck
    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    # Static (se você usa /static/)
    location /static/ {
        alias /static/;
        access_log off;
        expires 7d;
    }

    # Media (uploads)
    location /media/ {
        alias /usr/share/nginx/html/media/;
        access_log off;
        expires 7d;
    }

    # API (CORS + proxy)
    location /api/ {

        # ---- CORS (obrigatório para Pages -> API) ----
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-CSRFToken" always;
        add_header Vary                             "Origin" always;

        # Responde preflight aqui mesmo (sem bater no Django)
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass http://django;

        proxy_set_header Host                $host;
        proxy_set_header X-Real-IP           $remote_addr;
        proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto   $proxy_proto;
        proxy_set_header X-Forwarded-Host    $host;

        proxy_redirect off;
        client_max_body_size 20m;
    }

    # Opcional: se quiser acessar admin etc pelo túnel
    location / {
        proxy_pass http://django;

        proxy_set_header Host                $host;
        proxy_set_header X-Real-IP           $remote_addr;
        proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto   $proxy_proto;
        proxy_set_header X-Forwarded-Host    $host;

        proxy_redirect off;
        client_max_body_size 20m;
    }
}
