# ========= CORS (Pages -> API) =========
# Permite somente esses origins. Ajuste se precisar.
map $http_origin $cors_origin {
    default "";
    "https://galileu.pages.dev" $http_origin;
    "http://localhost:5500" $http_origin;
    "http://127.0.0.1:5500" $http_origin;
}

server {
    listen 80;
    server_name _;

    client_max_body_size 20m;

    # ========= API =========
    location /api/ {

        # ---- Preflight (OPTIONS) ----
        if ($request_method = OPTIONS) {
            # se origin não é permitido, nega
            if ($cors_origin = "") { return 403; }

            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type, X-CSRFToken' always;
            add_header 'Vary' 'Origin' always;

            add_header 'Content-Length' 0;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            return 204;
        }

        # ---- Respostas normais ----
        if ($cors_origin != "") {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Vary' 'Origin' always;
        }

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ✅ ajuste se seu Django estiver em outra porta
        proxy_pass http://web:8000;
    }

    # (Opcional) health check simples
    location = /healthz {
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }
}
